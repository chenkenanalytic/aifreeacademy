<!DOCTYPE html>{% load static %}
<html lang="zh-Hant">
{% include 'academy/default/head.html' %}
<body class="page-container">
  <!-- Navbar -->
  {% include 'academy/default/navbar.html' %}

  <!-- Hero search bar -->
  <header class="bg-primary py-5">
    <div class="container">
      <h1 class="text-white fw-bold mb-3 text-center">找課程 · 開啟你的學習旅程</h1>
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="input-group input-group-lg shadow-sm">
            <input type="text" id="searchInput" class="form-control" placeholder="輸入關鍵字，例如：Python、行銷、英語..."/>
            <button class="btn btn-dark" id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i></button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Filter toggle button (mobile) -->
  <button class="btn btn-primary d-lg-none filter-btn" data-bs-toggle="offcanvas" data-bs-target="#filterCanvas"><i class="fa-solid fa-filter"></i></button>

  <!-- Main -->
  <div class="container-fluid container py-5">
    <div class="row gx-lg-5">
      <!-- Sidebar filters -->
      <aside class="col-lg-3 d-none d-lg-block">
        <h5 class="fw-bold mb-3"><i class="fa-solid fa-filter me-2"></i>搜尋條件</h5>
        <div class="mb-4">
          <label class="form-label fw-semibold">課程類別</label>
          <div class="form-check"><input class="form-check-input category-filter" type="checkbox" value="code" id="catCode"><label class="form-check-label" for="catCode">軟體開發</label></div>
          <div class="form-check"><input class="form-check-input category-filter" type="checkbox" value="data_analytics" id="catDA"><label class="form-check-label" for="catDA">數據分析</label></div>
          <div class="form-check"><input class="form-check-input category-filter" type="checkbox" value="data_science" id="catDS"><label class="form-check-label" for="catDS">資料科學</label></div>
          <div class="form-check"><input class="form-check-input category-filter" type="checkbox" value="deeplearning" id="catDL"><label class="form-check-label" for="catDL">深度學習</label></div>
          <div class="form-check"><input class="form-check-input category-filter" type="checkbox" value="llm" id="catLlm"><label class="form-check-label" for="catLlm">LLM 開發</label></div>
          <div class="form-check"><input class="form-check-input category-filter" type="checkbox" value="ai_drawing" id="catDraw"><label class="form-check-label" for="catDraw">AI 繪圖</label></div>
        </div>
        <div class="mb-4">
          <label class="form-label fw-semibold">課程價格區間 (NT$)</label>
          <input type="range" class="form-range" min="500" max="5000" step="100" id="priceRange"/>
          <span id="priceValue" class="small text-muted">請選擇您的預算</span>
        </div>
        <div class="mb-4">
          <button class="btn btn-sm btn-secondary me-2" id="resetBtn">重設</button>
          <button class="btn btn-sm btn-primary" id="applyBtn">套用</button>
        </div>
      </aside>

      <!-- Offcanvas filters (mobile) -->
      <div class="offcanvas offcanvas-end" tabindex="-1" id="filterCanvas">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title"><i class="fa-solid fa-filter me-2"></i>搜尋條件</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
          <!-- 內容複製 sidebar -->
          <div id="mobileFilters"></div>
        </div>
      </div>

      <!-- Course list -->
      <section class="col-lg-9">
        <div id="resultCount" class="mb-4 fw-semibold"></div>
        <div class="row g-4" id="courseList">
          <!-- Sample courses (data-* attributes for filtering) -->
          <!-- <div class="col-md-6 col-xl-4" data-title="Python 從入門到實戰" data-category="code" data-price="1980">
            <a href="/academy/course/" class="text-decoration-none"><div class="card course-card h-100">
              <img src='/static/academy/img/hero.png' class="card-img-top" alt="Python">
              <div class="card-body" style="padding-bottom: 0px;">
                <h6 class="fw-bold">Python 從入門到實戰</h6>
                <p class="small text-truncate">最受歡迎的新手程式課，快速掌握基礎</p>
              </div>
              <div class="card-footer bg-white border-0 d-flex justify-content-between">
                <span class="fw-bold text-primary">NT$ 1,980</span>
                <span class="text-muted small">
                  <i class="fa-solid fa-users me-1"></i><strong> 學員:</strong> 0 &nbsp;
                  <i class="fa-solid fa-user me-1"></i><strong> 講師: </strong>王大明
                </span>
              </div>
            </div></a>
          </div>
          <div class="col-md-6 col-xl-4" data-title="UX/UI 設計全攻略" data-category="design" data-price="2480">
            <a href="/academy/course/" class="text-decoration-none"><div class="card course-card h-100">
              <img src='/static/academy/img/hero.png' class="card-img-top" alt="UX">
              <div class="card-body" style="padding-bottom: 0px;">
                <h6 class="fw-bold">UX/UI 設計全攻略</h6>
                <p class="small text-truncate">零基礎也能打造高質感介面</p>
              </div>
              <div class="card-footer bg-white border-0 d-flex justify-content-between">
                <span class="fw-bold text-primary">NT$ 2,480</span>
                <span class="text-muted small">
                  <i class="fa-solid fa-users me-1"></i><strong> 學員:</strong> 0 &nbsp;
                  <i class="fa-solid fa-user me-1"></i><strong> 講師: </strong>王大明
                </span>
              </div>
            </div></a>
          </div>
          <div class="col-md-6 col-xl-4" data-title="數位行銷成長黑客" data-category="business" data-price="1680">
            <a href="/academy/course/" class="text-decoration-none"><div class="card course-card h-100">
              <img src='/static/academy/img/hero.png' class="card-img-top" alt="Marketing">
              <div class="card-body" style="padding-bottom: 0px;">
                <h6 class="fw-bold">數位行銷成長黑客</h6>
                <p class="small text-truncate">掌握關鍵策略提高轉換率</p>
              </div>
              <div class="card-footer bg-white border-0 d-flex justify-content-between">
                <span class="fw-bold text-primary">NT$ 1,680</span>
                <span class="text-muted small">
                  <i class="fa-solid fa-users me-1"></i><strong> 學員:</strong> 0 &nbsp;
                  <i class="fa-solid fa-user me-1"></i><strong> 講師: </strong>王大明
                </span>
              </div>
            </div></a>
          </div>
          <div class="col-md-6 col-xl-4" data-title="零基礎日文實用會話" data-category="language" data-price="1280">
            <a href="/academy/course/" class="text-decoration-none"><div class="card course-card h-100">
              <img src='/static/academy/img/hero.png' class="card-img-top" alt="Japanese">
              <div class="card-body">
                <h6 class="fw-bold">零基礎日文實用會話</h6>
                <p class="small text-truncate">生活常用句輕鬆開口說</p>
              </div>
              <div class="card-footer bg-white border-0 d-flex justify-content-between">
                <span class="fw-bold text-primary">NT$ 1,280</span>
                <span class="text-muted small">
                  <i class="fa-solid fa-users me-1"></i><strong> 學員:</strong> 0 &nbsp;
                  <i class="fa-solid fa-user me-1"></i><strong> 講師: </strong>王大明
                </span>
              </div>
            </div>
          </div></a> -->
        </div>
        <div id="loading" class="text-center text-muted py-3">載入中...</div>
      </section>
    </div>
  </div>

  <!-- Footer -->
  {% include 'academy/default/footer.html' %}

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentPage = 1;
    let loading = false;
    
    function loadMoreCourses() {
      if (loading) return;
      loading = true;
      document.getElementById('loading').innerText = '載入中...';
    
      fetch(`/academy/api/courses/?page=${currentPage + 1}`)
        .then(res => res.json())
        .then(data => {
          data.courses.forEach(c => {
            const html = `
              <div class="col-md-6 col-xl-4" data-title="${c.title}" data-category="${c.category}" data-price="${c.price}">
                <a href="/academy/course/${c.slug}/" class="text-decoration-none">
                  <div class="card course-card h-100">
                    <img src="${c.img}" class="card-img-top" alt="${c.title}">
                    <div class="card-body" style="padding-bottom: 0px;">
                      <h6 class="fw-bold">${c.title}</h6>
                      <p class="small text-truncate">${c.subtitle}</p>
                    </div>
                    <div class="card-footer bg-white border-0 d-flex justify-content-between">
                      <span class="fw-bold text-primary">NT$ ${c.price}</span>
                      <span class="text-muted small">
                        <i class="fa-solid fa-users me-1"></i><strong> 學員:</strong> ${c.students} &nbsp;
                        <i class="fa-solid fa-user me-1"></i><strong> 講師: </strong>${c.instructor}
                      </span>
                    </div>
                  </div>
                </a>
              </div>
            `;
            document.getElementById('courseList').insertAdjacentHTML('beforeend', html);
          });
    
          if (data.has_next) {
            currentPage++;
            loading = false;
          } else {
            document.getElementById('loading').innerText = '已載入全部課程';
          }filterCourses(); 
        });
    }
    
    // 當滾到底觸發載入
    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
        loadMoreCourses();
      }
    });
    
    window.addEventListener('DOMContentLoaded', () => {
      loadMoreCourses();

    });
  </script>
  <script>
  // 將 sidebar 內容複製進 offcanvas（行動版）
  document.getElementById('mobileFilters').innerHTML = document.querySelector('aside').innerHTML;

  const searchInput = document.getElementById('searchInput');
  const priceRange = document.getElementById('priceRange');
  const priceValue = document.getElementById('priceValue');

  function getCourseCards() {
    return [...document.querySelectorAll('#courseList > [data-title]')];
  }

  // 更新價格顯示
  priceRange.addEventListener('input', () => {
    priceValue.textContent = `上限：${priceRange.value === '5000' ? '5000+' : priceRange.value}`;
  });

  // 篩選主程式（每次都動態抓最新的課程）
  function filterCourses() {
    const q = searchInput.value.toLowerCase();
    const maxPrice = parseInt(priceRange.value, 10);
    const checkedCats = [...document.querySelectorAll('.category-filter:checked')].map(c => c.value);
    let visible = 0;
    let courseCards = getCourseCards();  // 重新抓 DOM

    courseCards.forEach(card => {
      const title = card.dataset.title.toLowerCase();
      const category = card.dataset.category;
      const price = parseInt(card.dataset.price, 10);
      const matchSearch = title.includes(q);
      const matchPrice = price <= maxPrice;
      
      const matchCat = checkedCats.length
      ? category.split(',').some(cat => checkedCats.includes(cat))
      : true;
      if (matchSearch && matchPrice && matchCat) {
        card.classList.remove('d-none');
        visible++;
      } else {
        card.classList.add('d-none');
      }
    });

    document.getElementById('resultCount').textContent = `共有 ${visible} 門課程符合條件`;
  }

  // 事件監聽
  searchInput.addEventListener('keyup', filterCourses);
  document.getElementById('searchBtn').addEventListener('click', filterCourses);
  document.querySelectorAll('.category-filter').forEach(cb => cb.addEventListener('change', filterCourses));
  priceRange.addEventListener('change', filterCourses);
  document.getElementById('applyBtn').addEventListener('click', filterCourses);
  document.getElementById('resetBtn').addEventListener('click', () => {
    searchInput.value = '';
    priceRange.value = 5000;
    priceValue.textContent = 'NTD $5,000';
    document.querySelectorAll('.category-filter').forEach(cb => cb.checked = false);
    filterCourses();
  });

  // 初始統計
  filterCourses();
</script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
  // URL 參數轉成物件
  const params = new URLSearchParams(window.location.search);
  const category = params.get('category');

  // 若有帶入分類參數，自動勾選對應 checkbox
  if (category) {
    const checkbox = document.querySelector(`.category-filter[value="${category}"]`);
    if (checkbox) {
      checkbox.checked = true;
    }
  }

  filterCourses(); // 預設執行篩選
});
  </script>

</body>
</html>
